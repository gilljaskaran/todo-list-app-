name: Build, Push Docker image, and Deploy to Kubernetes

on:
  push:
    branches:
      - main  # Trigger the workflow when changes are pushed to the 'main' branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # Use Ubuntu for the CI environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v2  # Checks out the code from the repo

      - name: Log in to Docker Hub
        uses: docker/login-action@v2  # Log in to Docker Hub using credentials stored in secrets
        with:
          username: ${{ secrets.DOCKER_USERNAME }}  # GitHub secret for Docker Hub username
          password: ${{ secrets.DOCKER_PASSWORD }}  # GitHub secret for Docker Hub password

      - name: Build Docker image
        run: docker build -t your-dockerhub-username/todo-list-app .  # Build Docker image

      - name: Push Docker image to Docker Hub
        run: docker push your-dockerhub-username/todo-list-app  # Push the image to Docker Hub

      - name: Set up Kubernetes
        uses: azure/setup-kubectl@v1  # Sets up kubectl to manage Kubernetes deployments
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG }}  # GitHub secret for Kubernetes configuration

      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/todo-list-app-deployment \
          todo-list-app=your-dockerhub-username/todo-list-app:latest \
          --record  # Update the deployment to use the latest image from Docker Hub
